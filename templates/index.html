<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convertin - Ultimate File Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background: #050505;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .bg-gradient-system {
            position: fixed;
            inset: 0;
            z-index: -1;
            background: radial-gradient(circle at center, #11101d 0%, #050505 100%);
        }
        .blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(100px);
            z-index: -1;
            opacity: 0.25;
            mix-blend-mode: screen;
            animation: orbital 20s infinite linear;
        }
        .blob-1 {
            width: 600px;
            height: 600px;
            background: #4f46e5;
            top: -10%;
            left: -10%;
            animation-duration: 25s;
        }
        .blob-2 {
            width: 500px;
            height: 500px;
            background: #9333ea;
            bottom: -10%;
            right: -5%;
            animation-duration: 30s;
            animation-direction: reverse;
        }
        .blob-3 {
            width: 400px;
            height: 400px;
            background: #0ea5e9;
            top: 40%;
            left: 30%;
            animation-duration: 35s;
        }
        @keyframes orbital {
            0% { transform: rotate(0deg) translate(50px) rotate(0deg); }
            100% { transform: rotate(360deg) translate(50px) rotate(-360deg); }
        }
        .mesh-pattern {
            position: fixed;
            inset: 0;
            background-image: radial-gradient(rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: -1;
        }
        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .upload-zone:hover {
            border-color: #818cf8;
            background: rgba(129, 140, 248, 0.05);
        }
        .file-icon-glow {
            filter: drop-shadow(0 0 10px rgba(129, 140, 248, 0.4));
        }
        select option {
            background-color: #1f2937;
            color: white;
        }
        .rec-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .rec-card:hover {
            transform: translateY(-4px);
            background: rgba(129, 140, 248, 0.1);
            border-color: rgba(129, 140, 248, 0.4);
        }
        .rec-card.selected {
            background: rgba(129, 140, 248, 0.2);
            border-color: #818cf8;
            box-shadow: 0 0 20px rgba(129, 140, 248, 0.2);
        }
        .shimmer {
            background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.05) 50%, rgba(255,255,255,0) 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
    </style>
</head>
<body class="text-gray-200 flex flex-col items-center justify-center p-4">
    <div class="bg-gradient-system"></div>
    <div class="mesh-pattern"></div>
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div class="blob blob-3"></div>

    <main class="w-full max-w-2xl animate-in fade-in slide-in-from-bottom-4 duration-1000">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-indigo-600/20 mb-4 border border-indigo-500/30">
                <i data-lucide="refresh-cw" class="w-8 h-8 text-indigo-400"></i>
            </div>
            <h1 class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-purple-400 mb-2">Convertin</h1>
            <p class="text-gray-400 text-lg">Konversi Gambar, Audio, Video & Dokumen dengan Cepat</p>
        </div>

        <!-- Alerts -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="space-y-3 mb-6">
              {% for category, message in messages %}
                <div class="p-4 rounded-xl flex items-center gap-3 {% if category == 'success' %}bg-emerald-500/10 border border-emerald-500/20 text-emerald-400{% else %}bg-rose-500/10 border border-rose-500/20 text-rose-400{% endif %}">
                    <i data-lucide="{% if category == 'success' %}check-circle{% else %}alert-circle{% endif %}" class="w-5 h-5"></i>
                    <span>{{ message }}</span>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        <!-- Content Card -->
        <div class="glass rounded-3xl p-8 shadow-2xl relative overflow-hidden">
            {% if download_file %}
                <div class="text-center py-6">
                    <div class="w-20 h-20 bg-emerald-500/20 rounded-full flex items-center justify-center mx-auto mb-6 border border-emerald-500/30">
                        <i data-lucide="party-popper" class="w-10 h-10 text-emerald-400"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-white mb-2">Konversi Selesai!</h2>
                    <p class="text-gray-400 mb-8">File Anda sudah siap untuk diunduh.</p>
                    
                    <a href="{{ url_for('download_file', filename=download_file) }}" 
                       class="flex items-center justify-center gap-2 w-full bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white font-bold py-4 px-6 rounded-2xl transition-all shadow-lg shadow-emerald-500/20 hover:scale-[1.02]">
                        <i data-lucide="download" class="w-5 h-5"></i>
                        Download Sekarang
                    </a>
                    
                    <a href="/" class="inline-flex items-center gap-2 mt-8 text-indigo-400 hover:text-indigo-300 font-medium transition-colors">
                        <i data-lucide="arrow-left" class="w-4 h-4"></i>
                        Konversi File Lain
                    </a>
                </div>
            {% else %}
                <form id="batchForm" class="space-y-6">
                    <!-- Upload Zone -->
                    <div class="upload-zone group relative border-2 border-dashed border-gray-700/50 rounded-2xl p-8 cursor-pointer transition-all duration-300 overflow-hidden" 
                         onclick="document.getElementById('fileInput').click()">
                        
                        <input type="file" name="files" id="fileInput" class="hidden" multiple onchange="handleFileBatch(this)">
                        
                        <div id="dropPrompt" class="flex flex-col items-center gap-3 transition-transform group-hover:scale-105 duration-300">
                            <div class="w-14 h-14 bg-gray-800 rounded-full flex items-center justify-center group-hover:bg-indigo-600/20 transition-colors">
                                <i data-lucide="upload-cloud" class="w-6 h-6 text-gray-500 group-hover:text-indigo-400"></i>
                            </div>
                            <div class="text-center">
                                <p class="text-md font-semibold text-gray-300">Pilih atau Tarik File (Bisa Banyak)</p>
                                <p class="text-xs text-gray-500 mt-1">Mendukung Gambar, Audio, Video, & Dokumen</p>
                            </div>
                        </div>
                    </div>

                    <!-- File List Container -->
                    <div id="fileList" class="space-y-4 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
                        <!-- File items will be injected here -->
                    </div>

                    <!-- Batch Actions -->
                    <div id="batchActions" class="hidden animate-in fade-in slide-in-from-top-2">
                        <div class="flex gap-3">
                            <button type="button" onclick="resetUpload()" class="flex-1 bg-gray-800 hover:bg-gray-700 text-gray-300 font-bold py-4 px-6 rounded-2xl transition-all">
                                Reset
                            </button>
                            <button type="button" id="startBatchBtn" onclick="startBatchConversion()" 
                                    class="flex-[2] bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-4 px-6 rounded-2xl transition-all shadow-lg shadow-indigo-500/20 hover:scale-[1.02] flex items-center justify-center gap-2">
                                <i data-lucide="zap" class="w-5 h-5"></i>
                                Konversi Semua (<span id="fileCount">0</span>)
                            </button>
                        </div>
                    </div>

                    <!-- Final Download Area -->
                    <div id="finalActions" class="hidden text-center space-y-4 pt-4 border-t border-white/10 animate-in bounce-in duration-500">
                        <div class="w-16 h-16 bg-emerald-500/20 rounded-full flex items-center justify-center mx-auto mb-2 border border-emerald-500/30">
                            <i data-lucide="party-popper" class="w-8 h-8 text-emerald-400"></i>
                        </div>
                        <h2 class="text-xl font-bold text-white">Semua Selesai!</h2>
                        <button type="button" onclick="downloadAllAsZip()" 
                                class="w-full bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white font-bold py-4 px-6 rounded-2xl transition-all shadow-lg shadow-emerald-500/20 flex items-center justify-center gap-2">
                            <i data-lucide="archive" class="w-5 h-5"></i>
                            Download Semua (ZIP)
                        </button>
                        <p class="text-xs text-gray-500">Atau download satu per satu melalui daftar di atas.</p>
                    </div>
                </form>
            {% endif %}
        </div>
        
        <!-- Footer -->
        <div class="mt-8 pt-6 border-t border-white/10 text-center">
            <div class="flex items-center justify-center gap-2 mb-2 text-xs text-gray-400">
                <span class="flex items-center gap-1"><i data-lucide="box" class="w-3 h-3 text-indigo-400"></i> Local Storage</span>
                <span class="w-1 h-1 bg-gray-700 rounded-full"></span>
                <span class="flex items-center gap-1"><i data-lucide="zap" class="w-3 h-3 text-amber-400"></i> Redis/Celery Queue</span>
            </div>
            <p class="text-gray-400 text-sm mb-3">
                Developed with ❤️ by <span class="font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-purple-400">Gansputra</span>
            </p>
            
            <div class="flex justify-center gap-4">
                <a href="https://github.com/Gansputra" target="_blank" class="p-2 rounded-full bg-white/5 hover:bg-white/20 hover:text-pink-400 transition-all duration-300 transform hover:scale-110">
                    <i data-lucide="github" class="w-5 h-5"></i>
                </a>
                <a href="https://instagram.com/gans.putra_" target="_blank" class="p-2 rounded-full bg-white/5 hover:bg-white/20 hover:text-pink-500 transition-all duration-300 transform hover:scale-110">
                    <i data-lucide="instagram" class="w-5 h-5"></i>
                </a>
            </div>
        </div>
    </main>

    <!-- Global Progress (Hidden by default) -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black/80 backdrop-blur-md z-50 flex flex-col items-center justify-center text-center">
        <div class="relative w-24 h-24 mb-6">
            <div class="absolute inset-0 border-4 border-indigo-500/20 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-t-indigo-500 rounded-full animate-spin"></div>
        </div>
        <h3 id="loadingTitle" class="text-2xl font-bold text-white mb-2">Memproses...</h3>
        <p id="loadingDesc" class="text-gray-400 px-4">Mohon tunggu sebentar.</p>
    </div>

    <script>
        lucide.createIcons();

        let selectedFiles = []; // Array of objects { file, metadata, recommendation, target_format, preset, state, task_id, progress }
        let currentBatchId = null;

        const formatOptions = {
            'image': { ext: ['jpg', 'jpeg', 'png', 'webp', 'svg'], targets: ['PNG', 'JPG', 'WEBP'], icon: 'image' },
            'audio': { ext: ['mp3', 'wav', 'm4a', 'flac'], targets: ['MP3', 'WAV'], icon: 'music' },
            'video': { ext: ['mp4', 'mkv', 'avi', 'mov'], targets: ['MKV', 'MP4', 'GIF', 'MP3'], icon: 'video' },
            'document': { ext: ['pdf', 'docx', 'doc'], targets: ['PDF', 'DOCX', 'JPG', 'PNG'], icon: 'file-text' },
            'data': { ext: ['csv', 'json', 'xlsx'], targets: ['CSV', 'JSON', 'XLSX'], icon: 'table-2' }
        };

        async function handleFileBatch(input) {
            const files = Array.from(input.files);
            if (!files.length) return;

            // Show global loading while analyzing first file or setting up
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('loadingTitle').innerText = "Menganalisis Files...";

            for (let file of files) {
                const entry = {
                    file: file,
                    id: Math.random().toString(36).substr(2, 9),
                    state: 'analyzing',
                    progress: 0,
                    target_format: null,
                    preset: 'balanced',
                    metadata: null,
                    recommendation: null,
                    output_filename: null
                };
                selectedFiles.push(entry);
                renderFileItem(entry);

                // Run analysis in background for each
                analyzeFileEntry(entry);
            }

            document.getElementById('batchActions').classList.remove('hidden');
            document.getElementById('fileCount').innerText = selectedFiles.length;
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        async function analyzeFileEntry(entry) {
            const formData = new FormData();
            formData.append('file', entry.file);

            try {
                const response = await fetch('/analyze', { method: 'POST', body: formData });
                const data = await response.json();
                
                if (data.error) throw new Error(data.error);

                entry.metadata = data.metadata;
                entry.recommendation = data.recommendations[0];
                entry.target_format = entry.recommendation.target_format;
                entry.preset = entry.recommendation.preset;
                entry.state = 'ready';
                
                updateFileItemUI(entry);
            } catch (err) {
                console.error("Analysis failed for", entry.file.name, err);
                entry.state = 'error';
                updateFileItemUI(entry);
            }
        }

        function renderFileItem(entry) {
            const list = document.getElementById('fileList');
            const item = document.createElement('div');
            item.id = `file-${entry.id}`;
            item.className = "glass rounded-2xl p-4 border border-white/5 animate-in slide-in-from-right-4 duration-300";
            
            // Preview logic
            let previewHtml = `<div class="w-16 h-16 bg-gray-800 rounded-lg flex items-center justify-center"><i data-lucide="file" class="text-gray-600"></i></div>`;
            const type = entry.file.type;
            const url = URL.createObjectURL(entry.file);

            if (type.startsWith('image/')) {
                previewHtml = `<img src="${url}" class="w-16 h-16 object-cover rounded-lg">`;
            } else if (type.startsWith('video/')) {
                previewHtml = `<video src="${url}" class="w-16 h-16 object-cover rounded-lg"></video>`;
            } else if (type.startsWith('audio/')) {
                previewHtml = `<div class="w-16 h-16 bg-indigo-500/20 rounded-lg flex items-center justify-center text-indigo-400"><i data-lucide="music"></i></div>`;
            }

            item.innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="relative group/preview cursor-zoom-in" onclick="openPreview('${url}', '${type}')">
                        ${previewHtml}
                        <div class="absolute inset-0 bg-black/40 opacity-0 group-hover/preview:opacity-100 transition-opacity flex items-center justify-center rounded-lg">
                            <i data-lucide="maximize-2" class="w-4 h-4 text-white"></i>
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between mb-1">
                            <h4 class="font-bold text-white truncate text-sm" title="${entry.file.name}">${entry.file.name}</h4>
                            <span id="status-badge-${entry.id}" class="text-[9px] px-1.5 py-0.5 rounded bg-gray-700 text-gray-400 uppercase font-bold">ANALYZING</span>
                        </div>
                        <div id="details-${entry.id}" class="text-[10px] text-gray-500 flex flex-wrap gap-x-3 gap-y-1">
                            <span>Sizing: ${formatSize(entry.file.size)}</span>
                            <span id="meta-${entry.id}">Tunggu analisis...</span>
                        </div>
                        
                        <!-- Progress Area -->
                        <div id="progress-container-${entry.id}" class="hidden mt-3">
                            <div class="flex justify-between text-[9px] mb-1">
                                <span class="text-indigo-400 font-medium">Processing...</span>
                                <span id="progress-text-${entry.id}" class="text-gray-500">0%</span>
                            </div>
                            <div class="h-1.5 bg-gray-800 rounded-full overflow-hidden">
                                <div id="progress-bar-${entry.id}" class="h-full bg-indigo-500 transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Config Area (Hidden while processing) -->
                        <div id="config-${entry.id}" class="hidden mt-3 flex items-center gap-3">
                            <select onchange="updateEntryFormat('${entry.id}', this.value)" class="bg-white/5 border border-white/10 rounded-lg py-1 px-2 text-[10px] text-white focus:outline-none focus:ring-1 focus:ring-indigo-500">
                                <!-- Options will be injected -->
                            </select>
                            <span class="text-[9px] text-gray-400" id="rec-hint-${entry.id}"></span>
                        </div>
                    </div>
                    <button type="button" onclick="removeEntry('${entry.id}')" class="text-gray-600 hover:text-rose-400 transition-colors p-1">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            `;
            list.appendChild(item);
            lucide.createIcons();
        }

        function updateFileItemUI(entry) {
            const badge = document.getElementById(`status-badge-${entry.id}`);
            const metaSpan = document.getElementById(`meta-${entry.id}`);
            const configDiv = document.getElementById(`config-${entry.id}`);
            const recHint = document.getElementById(`rec-hint-${entry.id}`);
            const select = configDiv.querySelector('select');

            if (entry.state === 'ready') {
                badge.innerText = "READY";
                badge.className = "text-[9px] px-1.5 py-0.5 rounded bg-indigo-500/20 text-indigo-400 uppercase font-bold";
                
                const meta = entry.metadata;
                metaSpan.innerText = `${meta.format.toUpperCase()} ${meta.resolution ? '• ' + meta.resolution : ''} ${meta.duration ? '• ' + meta.duration.toFixed(1)+'s' : ''}`;
                
                // Populating select options
                select.innerHTML = '';
                const ext = entry.file.name.split('.').pop().toLowerCase();
                for (const [cat, data] of Object.entries(formatOptions)) {
                    if (data.ext.includes(ext)) {
                        data.targets.forEach(fmt => {
                            const opt = document.createElement('option');
                            opt.value = fmt.toLowerCase();
                            opt.text = fmt.toUpperCase();
                            if (fmt.toLowerCase() === entry.target_format.toLowerCase()) opt.selected = true;
                            select.appendChild(opt);
                        });
                        break;
                    }
                }
                
                recHint.innerText = `Recomended: ${entry.recommendation.target_format.toUpperCase()} (${entry.recommendation.preset})`;
                configDiv.classList.remove('hidden');
            } else if (entry.state === 'error') {
                badge.innerText = "UNSUPPORTED";
                badge.className = "text-[9px] px-1.5 py-0.5 rounded bg-rose-500/20 text-rose-400 uppercase font-bold";
                metaSpan.innerText = "Format ini belum didukung saat ini.";
            }
        }

        function updateEntryFormat(id, format) {
            const entry = selectedFiles.find(e => e.id === id);
            if (entry) entry.target_format = format;
        }

        function removeEntry(id) {
            selectedFiles = selectedFiles.filter(e => e.id !== id);
            document.getElementById(`file-${id}`).remove();
            document.getElementById('fileCount').innerText = selectedFiles.length;
            if (selectedFiles.length === 0) resetUpload();
        }

        async function startBatchConversion() {
            if (!selectedFiles.length) return;

            const formData = new FormData();
            selectedFiles.forEach(e => {
                formData.append('files[]', e.file);
                formData.append('formats[]', e.target_format);
                formData.append('presets[]', e.preset);
            });

            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('loadingTitle').innerText = "Mengupload...";
            document.getElementById('loadingDesc').innerText = "Proses upload sedang berjalan.";

            try {
                const response = await fetch('/batch-upload', { method: 'POST', body: formData });
                const data = await response.json();
                
                if (data.error) throw new Error(data.error);

                currentBatchId = data.batch_id;
                document.getElementById('loadingOverlay').classList.add('hidden');
                document.getElementById('batchActions').classList.add('hidden');
                
                // Map task IDs back to our entries
                data.tasks.forEach((task, idx) => {
                    selectedFiles[idx].task_id = task.task_id;
                    selectedFiles[idx].output_filename = task.output_filename;
                    selectedFiles[idx].state = 'processing';
                    
                    // Show progress bar
                    document.getElementById(`status-badge-${selectedFiles[idx].id}`).innerText = "QUEUED";
                    document.getElementById(`progress-container-${selectedFiles[idx].id}`).classList.remove('hidden');
                    document.getElementById(`config-${selectedFiles[idx].id}`).classList.add('hidden');
                    
                    pollTaskStatus(selectedFiles[idx]);
                });

            } catch (err) {
                alert("Upload failed: " + err.message);
                document.getElementById('loadingOverlay').classList.add('hidden');
            }
        }

        async function pollTaskStatus(entry) {
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`/task-status/${entry.task_id}`);
                    const data = await response.json();

                    const bar = document.getElementById(`progress-bar-${entry.id}`);
                    const text = document.getElementById(`progress-text-${entry.id}`);
                    const badge = document.getElementById(`status-badge-${entry.id}`);

                    if (data.state === 'PROGRESS') {
                        const progress = data.info.progress;
                        bar.style.width = `${progress}%`;
                        text.innerText = `${progress}%`;
                        badge.innerText = "PROCESSING";
                    } else if (data.state === 'PENDING') {
                        badge.innerText = "QUEUED";
                        text.innerText = "Waiting...";
                    } else if (data.state === 'SUCCESS') {
                        clearInterval(interval);
                        bar.style.width = `100%`;
                        bar.className = "h-full bg-emerald-500 transition-all";
                        text.innerText = `100%`;
                        text.className = "text-emerald-400";
                        badge.innerText = "DONE";
                        badge.className = "text-[9px] px-1.5 py-0.5 rounded bg-emerald-500/20 text-emerald-400 uppercase font-bold";
                        entry.state = 'done';
                        checkAllFinished();
                    } else if (data.state === 'FAILURE' || (data.info && data.info.status === 'error')) {
                        clearInterval(interval);
                        badge.innerText = "FAILED";
                        badge.className = "text-[9px] px-1.5 py-0.5 rounded bg-rose-500/20 text-rose-400 uppercase font-bold";
                        entry.state = 'error';
                        checkAllFinished();
                    }
                } catch (err) {
                    console.error("Polling error", err);
                }
            }, 1500);
        }

        function checkAllFinished() {
            const allFinished = selectedFiles.every(e => e.state === 'done' || e.state === 'error');
            if (allFinished) {
                document.getElementById('finalActions').classList.remove('hidden');
            }
        }

        async function downloadAllAsZip() {
            const convertedFiles = selectedFiles.filter(e => e.state === 'done').map(e => e.output_filename);
            
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('loadingTitle').innerText = "Mengompresi...";
            document.getElementById('loadingDesc').innerText = "Sedang membungkus hasil konversi ke file ZIP.";

            try {
                const response = await fetch('/create-zip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ batch_id: currentBatchId, filenames: convertedFiles })
                });
                const data = await response.json();
                
                // Need to poll zip task too
                const zipInterval = setInterval(async () => {
                    const res = await fetch(`/task-status/${data.task_id}`);
                    const status = await res.json();
                    if (status.state === 'SUCCESS') {
                        clearInterval(zipInterval);
                        document.getElementById('loadingOverlay').classList.add('hidden');
                        window.location.href = `/download/${data.zip_filename}`;
                    }
                }, 1000);
            } catch (err) {
                alert("ZIP creation failed");
                document.getElementById('loadingOverlay').classList.add('hidden');
            }
        }

        function resetUpload() {
            selectedFiles = [];
            currentBatchId = null;
            document.getElementById('fileInput').value = "";
            document.getElementById('fileList').innerHTML = "";
            document.getElementById('dropPrompt').classList.remove('hidden');
            document.getElementById('batchActions').classList.add('hidden');
            document.getElementById('finalActions').classList.add('hidden');
        }

        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function openPreview(url, type) {
            // Simple logic to show full screen preview
            const modal = document.createElement('div');
            modal.className = "fixed inset-0 bg-black/95 z-[100] flex items-center justify-center p-8 animate-in fade-in duration-300";
            modal.onclick = () => modal.remove();
            
            let content = '';
            if (type.startsWith('image/')) content = `<img src="${url}" class="max-w-full max-h-full rounded-xl">`;
            else if (type.startsWith('video/')) content = `<video src="${url}" controls autoplay class="max-w-full max-h-full rounded-xl"></video>`;
            else if (type.startsWith('audio/')) content = `<audio src="${url}" controls autoplay class="w-full max-w-md"></audio>`;
            else content = `<div class="text-white text-xl">Preview tidak tersedia untuk format ini.</div>`;
            
            modal.innerHTML = `
                <div class="relative w-full h-full flex items-center justify-center" onclick="event.stopPropagation()">
                    ${content}
                    <button onclick="this.closest('.fixed').remove()" class="absolute top-0 right-0 p-4 text-white hover:text-gray-400 transition-colors">
                        <i data-lucide="x" class="w-8 h-8"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
            lucide.createIcons();
        }
    </script>
</body>
</html>
