<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convertin - Ultimate File Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
    <script src="https://unpkg.com/wavesurfer.js@7"></script>
    <script src="https://unpkg.com/wavesurfer.js@7/dist/plugins/regions.min.js"></script>
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background: #050505;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .bg-gradient-system {
            position: fixed;
            inset: 0;
            z-index: -1;
            background: radial-gradient(circle at center, #11101d 0%, #050505 100%);
        }
        .blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(100px);
            z-index: -1;
            opacity: 0.25;
            mix-blend-mode: screen;
            animation: orbital 20s infinite linear;
        }
        .blob-1 {
            width: 600px;
            height: 600px;
            background: #4f46e5;
            top: -10%;
            left: -10%;
            animation-duration: 25s;
        }
        .blob-2 {
            width: 500px;
            height: 500px;
            background: #9333ea;
            bottom: -10%;
            right: -5%;
            animation-duration: 30s;
            animation-direction: reverse;
        }
        .blob-3 {
            width: 400px;
            height: 400px;
            background: #0ea5e9;
            top: 40%;
            left: 30%;
            animation-duration: 35s;
        }
        @keyframes orbital {
            0% { transform: rotate(0deg) translate(50px) rotate(0deg); }
            100% { transform: rotate(360deg) translate(50px) rotate(-360deg); }
        }
        .mesh-pattern {
            position: fixed;
            inset: 0;
            background-image: radial-gradient(rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: -1;
        }
        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .upload-zone:hover {
            border-color: #818cf8;
            background: rgba(129, 140, 248, 0.05);
        }
        .file-icon-glow {
            filter: drop-shadow(0 0 10px rgba(129, 140, 248, 0.4));
        }
        select option {
            background-color: #1f2937;
            color: white;
        }
        .rec-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .rec-card:hover {
            transform: translateY(-4px);
            background: rgba(129, 140, 248, 0.1);
            border-color: rgba(129, 140, 248, 0.4);
        }
        .rec-card.selected {
            background: rgba(129, 140, 248, 0.2);
            border-color: #818cf8;
            box-shadow: 0 0 20px rgba(129, 140, 248, 0.2);
        }
        .shimmer {
            background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.05) 50%, rgba(255,255,255,0) 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        /* noUiSlider Indigo Theme */
        .noUi-target {
            background: rgba(255, 255, 255, 0.05);
            border: none;
            border-radius: 999px;
            box-shadow: none;
            height: 6px;
        }
        .noUi-connect {
            background: #6366f1;
        }
        .noUi-handle {
            width: 16px !important;
            height: 16px !important;
            right: -8px !important;
            top: -6px !important;
            border-radius: 50%;
            background: #fff;
            border: 2px solid #6366f1;
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.4);
            cursor: pointer;
        }
        .noUi-handle::before, .noUi-handle::after { display: none; }
        .waveform-container {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 8px;
        }

        /* Modern Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.3);
            border-radius: 10px;
            transition: all 0.3s;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(99, 102, 241, 0.6);
        }

        /* Modern Custom Checkbox */
        .modern-checkbox {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }
        .modern-checkbox input {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }
        .modern-checkbox .cb-box {
            width: 18px;
            height: 18px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: transparent;
        }
        .modern-checkbox:hover .cb-box {
            background: rgba(99, 102, 241, 0.1);
            border-color: rgba(99, 102, 241, 0.3);
            transform: scale(1.05);
        }
        .modern-checkbox input:checked + .cb-box {
            background: #6366f1;
            border-color: #6366f1;
            box-shadow: 0 0 12px rgba(99, 102, 241, 0.4);
            color: white;
            animation: cb-pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes cb-pop {
            0% { transform: scale(0.8); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .modern-checkbox span {
            font-size: 11px;
            color: #9ca3af;
            transition: color 0.2s;
        }
        .modern-checkbox input:checked ~ span {
            color: #e5e7eb;
        }
    </style>
</head>
<body class="text-gray-200 flex flex-col items-center justify-center p-4">
    <div class="bg-gradient-system"></div>
    <div class="mesh-pattern"></div>
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div class="blob blob-3"></div>

    <main class="w-full max-w-2xl animate-in fade-in slide-in-from-bottom-4 duration-1000">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-indigo-600/20 mb-4 border border-indigo-500/30">
                <i data-lucide="refresh-cw" class="w-8 h-8 text-indigo-400"></i>
            </div>
            <h1 class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-purple-400 mb-2">Convertin</h1>
            <p class="text-gray-400 text-lg">Konversi Gambar, Audio, Video & Dokumen dengan Cepat</p>
        </div>

        <!-- Alerts -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="space-y-3 mb-6">
              {% for category, message in messages %}
                <div class="p-4 rounded-xl flex items-center gap-3 {% if category == 'success' %}bg-emerald-500/10 border border-emerald-500/20 text-emerald-400{% else %}bg-rose-500/10 border border-rose-500/20 text-rose-400{% endif %}">
                    <i data-lucide="{% if category == 'success' %}check-circle{% else %}alert-circle{% endif %}" class="w-5 h-5"></i>
                    <span>{{ message }}</span>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        <!-- Content Card -->
        <div class="glass rounded-3xl p-8 shadow-2xl relative overflow-hidden">
            {% if download_file %}
                <div class="text-center py-6">
                    <div class="w-20 h-20 bg-emerald-500/20 rounded-full flex items-center justify-center mx-auto mb-6 border border-emerald-500/30">
                        <i data-lucide="party-popper" class="w-10 h-10 text-emerald-400"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-white mb-2">Konversi Selesai!</h2>
                    <p class="text-gray-400 mb-8">File Anda sudah siap untuk diunduh.</p>
                    
                    <a href="{{ url_for('download_file', filename=download_file) }}" 
                       class="flex items-center justify-center gap-2 w-full bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white font-bold py-3 px-4 sm:py-4 sm:px-6 text-sm sm:text-base rounded-2xl transition-all shadow-lg shadow-emerald-500/20 hover:scale-[1.02]">
                        <i data-lucide="download" class="w-5 h-5"></i>
                        Download Sekarang
                    </a>
                    
                    <a href="/" class="inline-flex items-center gap-2 mt-8 text-indigo-400 hover:text-indigo-300 font-medium transition-colors">
                        <i data-lucide="arrow-left" class="w-4 h-4"></i>
                        Konversi File Lain
                    </a>
                </div>
            {% else %}
                <form id="batchForm" class="space-y-6">
                    <!-- Upload Zone -->
                    <div class="upload-zone group relative border-2 border-dashed border-gray-700/50 rounded-2xl p-8 cursor-pointer transition-all duration-300 overflow-hidden" 
                         onclick="document.getElementById('fileInput').click()">
                        
                        <input type="file" name="files" id="fileInput" class="hidden" multiple onchange="handleFileBatch(this)">
                        
                        <div id="dropPrompt" class="flex flex-col items-center gap-3 transition-transform group-hover:scale-105 duration-300">
                            <div class="w-14 h-14 bg-gray-800 rounded-full flex items-center justify-center group-hover:bg-indigo-600/20 transition-colors">
                                <i data-lucide="upload-cloud" class="w-6 h-6 text-gray-500 group-hover:text-indigo-400"></i>
                            </div>
                            <div class="text-center">
                                <p class="text-md font-semibold text-gray-300">Pilih atau Tarik File (Bisa Banyak)</p>
                                <p class="text-xs text-gray-500 mt-1">Mendukung Gambar, Audio, Video, & Dokumen</p>
                            </div>
                        </div>
                    </div>

                    <!-- File List Container -->
                    <div id="fileList" class="space-y-4 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
                        <!-- File items will be injected here -->
                    </div>

                    <!-- Batch Actions -->
                    <div id="batchActions" class="hidden animate-in fade-in slide-in-from-top-2">
                        <div class="flex gap-3">
                            <button type="button" onclick="resetUpload()" class="flex-1 bg-gray-800 hover:bg-gray-700 text-gray-300 font-bold py-3 px-4 sm:py-4 sm:px-6 text-sm sm:text-base rounded-2xl transition-all">
                                Reset
                            </button>
                            <button type="button" id="startBatchBtn" onclick="startBatchConversion()" 
                                    class="flex-[2] bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-3 px-4 sm:py-4 sm:px-6 text-sm sm:text-base rounded-2xl transition-all shadow-lg shadow-indigo-500/20 hover:scale-[1.02] flex items-center justify-center gap-2">
                                <i data-lucide="zap" class="w-5 h-5"></i>
                                Konversi Semua (<span id="fileCount">0</span>)
                            </button>
                        </div>
                    </div>

                    <!-- Final Download Area -->
                    <div id="finalActions" class="hidden text-center space-y-4 pt-4 border-t border-white/10 animate-in bounce-in duration-500">
                        <div class="w-16 h-16 bg-emerald-500/20 rounded-full flex items-center justify-center mx-auto mb-2 border border-emerald-500/30">
                            <i data-lucide="party-popper" class="w-8 h-8 text-emerald-400"></i>
                        </div>
                        <h2 class="text-xl font-bold text-white">Konversi Selesai!</h2>
                        
                        <!-- Single Download Button (Hidden by default) -->
                        <div id="singleDownloadArea" class="hidden">
                            <a id="singleDownloadBtn" href="#" 
                               class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-3 px-4 sm:py-4 sm:px-6 text-sm sm:text-base rounded-2xl transition-all shadow-lg shadow-indigo-500/20 flex items-center justify-center gap-2">
                                <i data-lucide="download" class="w-5 h-5"></i>
                                Download File Hasil
                            </a>
                        </div>

                        <!-- ZIP Download Button (Hidden by default) -->
                        <div id="zipDownloadArea" class="hidden">
                            <button type="button" onclick="downloadAllAsZip()" 
                                    class="w-full bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white font-bold py-3 px-4 sm:py-4 sm:px-6 text-sm sm:text-base rounded-2xl transition-all shadow-lg shadow-emerald-500/20 flex items-center justify-center gap-2">
                                <i data-lucide="archive" class="w-5 h-5"></i>
                                Download Semua (ZIP)
                            </button>
                        </div>

                        <p class="text-xs text-gray-500 font-medium">Klik tombol di atas untuk mengunduh hasil.</p>
                        
                        <button type="button" onclick="resetUpload()" class="text-indigo-400 hover:text-indigo-300 text-xs font-semibold">Konversi File Lain</button>
                    </div>
                </form>
            {% endif %}
        </div>
        
        <!-- Footer -->
        <div class="mt-8 pt-6 border-t border-white/10 text-center">
            <div class="flex items-center justify-center gap-2 mb-2 text-xs text-gray-400">
                <span class="flex items-center gap-1"><i data-lucide="box" class="w-3 h-3 text-indigo-400"></i> Local Storage</span>
                <span class="w-1 h-1 bg-gray-700 rounded-full"></span>
                <span class="flex items-center gap-1"><i data-lucide="zap" class="w-3 h-3 text-amber-400"></i> Redis/Celery Queue</span>
            </div>
            <p class="text-gray-400 text-sm mb-3">
                Developed with ❤️ by <span class="font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-purple-400">Gansputra</span>
            </p>
            
            <div class="flex justify-center gap-4">
                <a href="https://github.com/Gansputra" target="_blank" class="p-2 rounded-full bg-white/5 hover:bg-white/20 hover:text-pink-400 transition-all duration-300 transform hover:scale-110">
                    <i data-lucide="github" class="w-5 h-5"></i>
                </a>
                <a href="https://instagram.com/gans.putra_" target="_blank" class="p-2 rounded-full bg-white/5 hover:bg-white/20 hover:text-pink-500 transition-all duration-300 transform hover:scale-110">
                    <i data-lucide="instagram" class="w-5 h-5"></i>
                </a>
            </div>
        </div>
    </main>

    <!-- Global Progress (Hidden by default) -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black/80 backdrop-blur-md z-50 flex flex-col items-center justify-center text-center">
        <div class="relative w-24 h-24 mb-6">
            <div class="absolute inset-0 border-4 border-indigo-500/20 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-t-indigo-500 rounded-full animate-spin"></div>
        </div>
        <h3 id="loadingTitle" class="text-2xl font-bold text-white mb-2">Memproses...</h3>
        <p id="loadingDesc" class="text-gray-400 px-4">Mohon tunggu sebentar.</p>
    </div>

    <script>
        lucide.createIcons();

        let selectedFiles = []; 
        let currentBatchId = null;
        const componentInstances = {}; // Store WaveSurfer and Slider instances

        const formatOptions = {
            'image': { ext: ['jpg', 'jpeg', 'png', 'webp', 'svg'], targets: ['PNG', 'JPG', 'WEBP'], icon: 'image' },
            'audio': { ext: ['mp3', 'wav', 'm4a', 'flac'], targets: ['MP3', 'WAV'], icon: 'music' },
            'video': { ext: ['mp4', 'mkv', 'avi', 'mov'], targets: ['MKV', 'MP4', 'GIF', 'MP3'], icon: 'video' },
            'document': { ext: ['pdf', 'docx', 'doc'], targets: ['PDF', 'DOCX', 'JPG', 'PNG'], icon: 'file-text' },
            'data': { ext: ['csv', 'json', 'xlsx'], targets: ['CSV', 'JSON', 'XLSX'], icon: 'table-2' }
        };

        async function handleFileBatch(input) {
            const files = Array.from(input.files);
            if (!files.length) return;

            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('loadingTitle').innerText = "Menganalisis Files...";

            for (let file of files) {
                const entry = {
                    file: file,
                    id: Math.random().toString(36).substr(2, 9),
                    state: 'analyzing',
                    progress: 0,
                    target_format: null,
                    preset: 'balanced',
                    metadata: null,
                    recommendation: null,
                    output_filename: null,
                    edit_params: {}
                };
                selectedFiles.push(entry);
                renderFileItem(entry);
                analyzeFileEntry(entry);
            }

            document.getElementById('batchActions').classList.remove('hidden');
            document.getElementById('fileCount').innerText = selectedFiles.length;
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        async function analyzeFileEntry(entry) {
            const formData = new FormData();
            formData.append('file', entry.file);
            try {
                const response = await fetch('/analyze', { method: 'POST', body: formData });
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                entry.metadata = data.metadata;
                entry.recommendation = data.recommendations[0];
                entry.target_format = entry.recommendation.target_format;
                entry.preset = entry.recommendation.preset;
                entry.state = 'ready';
                updateFileItemUI(entry);
            } catch (err) {
                entry.state = 'error';
                updateFileItemUI(entry);
            }
        }

        function renderFileItem(entry) {
            const list = document.getElementById('fileList');
            const item = document.createElement('div');
            item.id = `file-${entry.id}`;
            item.className = "glass rounded-2xl p-4 border border-white/5 animate-in slide-in-from-right-4 duration-300";
            
            const type = entry.file.type;
            const url = URL.createObjectURL(entry.file);
            let previewHtml = `<div class="w-16 h-16 bg-gray-800 rounded-lg flex items-center justify-center"><i data-lucide="file" class="text-gray-600"></i></div>`;

            if (type.startsWith('image/')) previewHtml = `<img src="${url}" class="w-16 h-16 object-cover rounded-lg">`;
            else if (type.startsWith('video/')) previewHtml = `<video src="${url}" class="w-16 h-16 object-cover rounded-lg"></video>`;
            else if (type.startsWith('audio/')) previewHtml = `<div class="w-16 h-16 bg-indigo-500/20 rounded-lg flex items-center justify-center text-indigo-400"><i data-lucide="music"></i></div>`;

            item.innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="relative group/preview cursor-zoom-in" onclick="openPreview('${url}', '${type}')">
                        ${previewHtml}
                        <div class="absolute inset-0 bg-black/40 opacity-0 group-hover/preview:opacity-100 transition-opacity flex items-center justify-center rounded-lg">
                            <i data-lucide="maximize-2" class="w-4 h-4 text-white"></i>
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between mb-1">
                            <h4 class="font-bold text-white truncate text-sm" title="${entry.file.name}">${entry.file.name}</h4>
                            <span id="status-badge-${entry.id}" class="text-[9px] px-1.5 py-0.5 rounded bg-gray-700 text-gray-400 uppercase font-bold">ANALYZING</span>
                        </div>
                        <div id="details-${entry.id}" class="text-[10px] text-gray-500 flex flex-wrap gap-x-3 gap-y-1">
                            <span>Sizing: ${formatSize(entry.file.size)}</span>
                            <span id="meta-${entry.id}">Tunggu analisis...</span>
                        </div>
                        <div id="progress-container-${entry.id}" class="hidden mt-3">
                            <div class="flex justify-between text-[9px] mb-1">
                                <span class="text-indigo-400 font-medium">Processing...</span>
                                <span id="progress-text-${entry.id}" class="text-gray-500">0%</span>
                            </div>
                            <div class="h-1.5 bg-gray-800 rounded-full overflow-hidden">
                                <div id="progress-bar-${entry.id}" class="h-full bg-indigo-500 transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>
                        <div id="config-${entry.id}" class="hidden mt-3 flex items-center gap-3">
                            <select onchange="updateEntryFormat('${entry.id}', this.value)" class="bg-white/5 border border-white/10 rounded-lg py-1 px-2 text-[10px] text-white focus:outline-none focus:ring-1 focus:ring-indigo-500"></select>
                            <span class="text-[9px] text-gray-400" id="rec-hint-${entry.id}"></span>
                            <button type="button" onclick="toggleEditPanel('${entry.id}')" id="edit-btn-${entry.id}" class="ml-auto flex items-center gap-1.5 px-2 py-1 bg-indigo-500/10 hover:bg-indigo-500/20 text-indigo-400 rounded-lg text-[9px] font-bold transition-all border border-indigo-500/20">
                                <i data-lucide="sliders" class="w-3 h-3"></i> EDIT TOOLS
                            </button>
                        </div>
                    </div>
                    <button type="button" onclick="removeEntry('${entry.id}')" class="text-gray-600 hover:text-rose-400 transition-colors p-1"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
                <div id="edit-panel-${entry.id}" class="hidden mt-4 pt-4 border-t border-white/5 animate-in slide-in-from-top-2">
                    <div id="visual-editor-${entry.id}" class="mb-4"></div>
                    <div class="grid grid-cols-2 gap-4" id="tools-container-${entry.id}"></div>
                </div>
            `;
            list.appendChild(item);
            lucide.createIcons();
        }

        function toggleEditPanel(id) {
            const panel = document.getElementById(`edit-panel-${id}`);
            const btn = document.getElementById(`edit-btn-${id}`);
            const entry = selectedFiles.find(e => e.id === id);
            
            panel.classList.toggle('hidden');
            if (panel.classList.contains('hidden')) {
                btn.classList.remove('bg-indigo-500/30', 'border-indigo-500/50');
            } else {
                btn.classList.add('bg-indigo-500/30', 'border-indigo-500/50');
                if (entry && (entry.file.type.startsWith('audio/') || entry.file.type.startsWith('video/'))) {
                    initVisualTrimmer(entry);
                }
            }
        }

        function initVisualTrimmer(entry) {
            const container = document.getElementById(`visual-editor-${entry.id}`);
            if (container.innerHTML !== "") return; // Already init

            const url = URL.createObjectURL(entry.file);
            const duration = entry.metadata.duration || 0;

            if (entry.file.type.startsWith('audio/')) {
                const waveId = `wave-${entry.id}`;
                container.innerHTML = `
                    <div class="waveform-container">
                        <div id="${waveId}"></div>
                    </div>
                    <div class="flex items-center justify-between text-[10px] text-gray-500 mt-2">
                        <span id="time-start-${entry.id}">00:00</span>
                        <div class="flex gap-2">
                             <button type="button" onclick="componentInstances['${entry.id}'].ws.playPause()" class="p-1 px-2 bg-white/10 rounded hover:bg-white/20"><i data-lucide="play" class="w-3 h-3 inline"></i> Play/Pause</button>
                        </div>
                        <span id="time-end-${entry.id}">${formatTime(duration)}</span>
                    </div>
                `;
                
                const ws = WaveSurfer.create({
                    container: `#${waveId}`,
                    waveColor: '#4f46e5',
                    progressColor: '#818cf8',
                    cursorColor: '#fff',
                    height: 50,
                    plugins: [WaveSurfer.Regions.create()]
                });

                ws.load(url);
                ws.on('ready', () => {
                   const region = ws.registerPlugin(WaveSurfer.Regions.create()).addRegion({
                        start: 0,
                        end: duration * 0.8,
                        color: 'rgba(99, 102, 241, 0.2)',
                        drag: true,
                        resize: true
                    });
                    
                    region.on('update-end', () => {
                        updateEditParam(entry.id, 'trim_start', region.start.toFixed(2));
                        updateEditParam(entry.id, 'trim_end', region.end.toFixed(2));
                        document.getElementById(`time-start-${entry.id}`).innerText = formatTime(region.start);
                        document.getElementById(`time-end-${entry.id}`).innerText = formatTime(region.end);
                    });
                    
                    // Set initial
                    updateEditParam(entry.id, 'trim_start', "0.00");
                    updateEditParam(entry.id, 'trim_end', (duration * 0.8).toFixed(2));
                });
                
                componentInstances[entry.id] = { ws };
            } else if (entry.file.type.startsWith('video/')) {
                const videoId = `vid-edit-${entry.id}`;
                const sliderId = `slider-${entry.id}`;
                container.innerHTML = `
                    <div class="relative rounded-xl overflow-hidden bg-black aspect-video mb-3">
                        <video id="${videoId}" src="${url}" class="w-full h-full"></video>
                        <div class="absolute bottom-2 left-2 right-2 px-4 py-2 bg-black/60 backdrop-blur rounded-lg flex items-center gap-3">
                            <button type="button" onclick="toggleVideoPlay('${videoId}')" class="text-white"><i data-lucide="play" class="w-4 h-4"></i></button>
                            <span class="text-[10px] text-white" id="vid-time-${entry.id}">00:00 / ${formatTime(duration)}</span>
                        </div>
                    </div>
                    <div class="px-2 pt-2">
                        <div id="${sliderId}" class="mb-6"></div>
                        <div class="flex justify-between text-[10px] text-gray-500 -mt-2">
                            <span id="v-start-${entry.id}">00:00</span>
                            <span id="v-end-${entry.id}">${formatTime(duration)}</span>
                        </div>
                    </div>
                `;

                const video = document.getElementById(videoId);
                const slider = document.getElementById(sliderId);

                noUiSlider.create(slider, {
                    start: [0, duration],
                    connect: true,
                    range: { 'min': 0, 'max': duration }
                });

                slider.noUiSlider.on('update', (values) => {
                    const start = parseFloat(values[0]);
                    const end = parseFloat(values[1]);
                    document.getElementById(`v-start-${entry.id}`).innerText = formatTime(start);
                    document.getElementById(`v-end-${entry.id}`).innerText = formatTime(end);
                    updateEditParam(entry.id, 'trim_start', start.toFixed(2));
                    updateEditParam(entry.id, 'trim_end', end.toFixed(2));
                    
                    // Preview seek to start when adjusting
                    video.currentTime = start;
                });

                video.ontimeupdate = () => {
                    document.getElementById(`vid-time-${entry.id}`).innerText = `${formatTime(video.currentTime)} / ${formatTime(duration)}`;
                };

                componentInstances[entry.id] = { slider };
            }
            lucide.createIcons();
        }

        function toggleVideoPlay(id) {
            const v = document.getElementById(id);
            if (v.paused) v.play(); else v.pause();
        }

        function updateFileItemUI(entry) {
            const badge = document.getElementById(`status-badge-${entry.id}`);
            const metaSpan = document.getElementById(`meta-${entry.id}`);
            const configDiv = document.getElementById(`config-${entry.id}`);
            const select = configDiv.querySelector('select');
            const toolsContainer = document.getElementById(`tools-container-${entry.id}`);

            if (entry.state === 'ready') {
                badge.innerText = "READY";
                badge.className = "text-[9px] px-1.5 py-0.5 rounded bg-indigo-500/20 text-indigo-400 uppercase font-bold";
                const meta = entry.metadata;
                metaSpan.innerText = `${meta.format.toUpperCase()} ${meta.resolution ? '• ' + meta.resolution : ''} ${meta.duration ? '• ' + meta.duration.toFixed(1)+'s' : ''}`;
                
                select.innerHTML = '';
                const ext = entry.file.name.split('.').pop().toLowerCase();
                let fileCategory = '';
                for (const [cat, data] of Object.entries(formatOptions)) {
                    if (data.ext.includes(ext)) {
                        fileCategory = cat;
                        data.targets.forEach(fmt => {
                            const opt = document.createElement('option');
                            opt.value = fmt.toLowerCase(); opt.text = fmt.toUpperCase();
                            if (fmt.toLowerCase() === entry.target_format.toLowerCase()) opt.selected = true;
                            select.appendChild(opt);
                        });
                        break;
                    }
                }
                
                let toolsHtml = '';
                if (fileCategory === 'video') {
                    toolsHtml = `
                        <div class="space-y-2">
                            <label class="text-[9px] font-bold text-gray-500 uppercase tracking-wider">Resolusi</label>
                            <select onchange="updateEditParam('${entry.id}', 'resolution', this.value)" class="w-full bg-white/5 border border-white/10 rounded-lg px-2 py-1.5 text-[10px] text-white">
                                <option value="">Original</option>
                                <option value="720p">720p (HD)</option>
                                <option value="480p">480p (SD)</option>
                                <option value="360p">360p</option>
                            </select>
                        </div>
                        <div class="col-span-2 mt-2">
                            <label class="modern-checkbox">
                                <input type="checkbox" onchange="updateEditParam('${entry.id}', 'extract_audio', this.checked)">
                                <div class="cb-box">
                                    <i data-lucide="check" class="w-3 h-3"></i>
                                </div>
                                <span>Ekstrak Audio Saja</span>
                            </label>
                        </div>
                    `;
                } else if (fileCategory === 'image') {
                    const w = entry.metadata.width;
                    const h = entry.metadata.height;
                    toolsHtml = `
                        <div class="col-span-2 space-y-3">
                            <label class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest flex items-center gap-2">
                                <i data-lucide="maximize" class="w-3 h-3"></i> RESOLUSI OUTPUT
                            </label>
                            <div class="relative group">
                                <select onchange="handleImageResolutionChange('${entry.id}', this.value)" 
                                        class="w-full bg-indigo-500/5 border border-indigo-500/20 rounded-xl px-4 py-3 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/40 appearance-none cursor-pointer hover:bg-indigo-500/10 transition-all shadow-inner">
                                    <option value="original">Kualitas Asli (${w}x${h} px)</option>
                                    <option value="75">Besar (75% • ${Math.round(w*0.75)}x${Math.round(h*0.75)} px)</option>
                                    <option value="50">Sedang (50% • ${Math.round(w*0.5)}x${Math.round(h*0.5)} px)</option>
                                    <option value="25">Kecil (25% • ${Math.round(w*0.25)}x${Math.round(h*0.25)} px)</option>
                                </select>
                                <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-indigo-400 group-hover:text-indigo-300 transition-colors">
                                    <i data-lucide="chevron-down" class="w-4 h-4"></i>
                                </div>
                            </div>
                            <p class="text-[10px] text-gray-500 italic">Pilih resolusi yang sesuai dengan kebutuhan Anda. Persentase dihitung dari ukuran asli.</p>
                        </div>
                    `;
                } else if (fileCategory === 'audio') {
                    toolsHtml = `
                        <div class="col-span-2 mt-2">
                            <label class="modern-checkbox">
                                <input type="checkbox" onchange="updateEditParam('${entry.id}', 'noise_reduction', this.checked)">
                                <div class="cb-box">
                                    <i data-lucide="check" class="w-3 h-3"></i>
                                </div>
                                <span>Noise Reduction (FFT)</span>
                            </label>
                        </div>
                    `;
                } else {
                    toolsHtml = '';
                    document.getElementById(`edit-btn-${entry.id}`).classList.add('hidden');
                }
                toolsContainer.innerHTML = toolsHtml;
                lucide.createIcons();
                document.getElementById(`rec-hint-${entry.id}`).innerText = `Recommended: ${entry.recommendation.target_format.toUpperCase()}`;
                configDiv.classList.remove('hidden');
            } else if (entry.state === 'error') {
                badge.innerText = "UNSUPPORTED";
                badge.className = "text-[9px] px-1.5 py-0.5 rounded bg-rose-500/20 text-rose-400 uppercase font-bold";
                metaSpan.innerText = "Format ini belum didukung.";
            }
        }

        function handleImageResolutionChange(id, value) {
            const entry = selectedFiles.find(e => e.id === id);
            if (!entry) return;
            
            const w = entry.metadata.width;
            const h = entry.metadata.height;
            
            if (value === 'original') {
                delete entry.edit_params.width;
                delete entry.edit_params.height;
            } else {
                const scale = parseInt(value) / 100;
                entry.edit_params.width = Math.round(w * scale);
                entry.edit_params.height = Math.round(h * scale);
            }
        }

        function updateEditParam(id, key, value) {
            const entry = selectedFiles.find(e => e.id === id);
            if (entry) {
                if (value === "" || value === false) delete entry.edit_params[key];
                else entry.edit_params[key] = value;
            }
        }

        function updateEntryFormat(id, format) {
            const entry = selectedFiles.find(e => e.id === id);
            if (entry) entry.target_format = format;
        }

        function removeEntry(id) {
            selectedFiles = selectedFiles.filter(e => e.id !== id);
            document.getElementById(`file-${id}`).remove();
            document.getElementById('fileCount').innerText = selectedFiles.length;
            if (selectedFiles.length === 0) resetUpload();
        }

        async function startBatchConversion() {
            if (!selectedFiles.length) return;
            const formData = new FormData();
            selectedFiles.forEach(e => {
                formData.append('files[]', e.file);
                formData.append('formats[]', e.target_format);
                formData.append('presets[]', e.preset);
                formData.append('edit_params[]', JSON.stringify(e.edit_params));
            });
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('loadingTitle').innerText = "Mengupload...";
            try {
                const response = await fetch('/batch-upload', { method: 'POST', body: formData });
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                currentBatchId = data.batch_id;
                document.getElementById('loadingOverlay').classList.add('hidden');
                document.getElementById('batchActions').classList.add('hidden');
                data.tasks.forEach((task, idx) => {
                    selectedFiles[idx].task_id = task.task_id;
                    selectedFiles[idx].output_filename = task.output_filename;
                    selectedFiles[idx].state = 'processing';
                    document.getElementById(`status-badge-${selectedFiles[idx].id}`).innerText = "QUEUED";
                    document.getElementById(`progress-container-${selectedFiles[idx].id}`).classList.remove('hidden');
                    document.getElementById(`config-${selectedFiles[idx].id}`).classList.add('hidden');
                    document.getElementById(`edit-panel-${selectedFiles[idx].id}`).classList.add('hidden');
                    pollTaskStatus(selectedFiles[idx]);
                });
            } catch (err) {
                alert("Upload failed: " + err.message);
                document.getElementById('loadingOverlay').classList.add('hidden');
            }
        }

        async function pollTaskStatus(entry) {
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`/task-status/${entry.task_id}`);
                    const data = await response.json();
                    const bar = document.getElementById(`progress-bar-${entry.id}`);
                    const text = document.getElementById(`progress-text-${entry.id}`);
                    const badge = document.getElementById(`status-badge-${entry.id}`);
                    if (data.state === 'PROGRESS') {
                        const progress = data.info.progress;
                        bar.style.width = `${progress}%`; text.innerText = `${progress}%`;
                        badge.innerText = "PROCESSING";
                    } else if (data.state === 'SUCCESS') {
                        clearInterval(interval);
                        bar.style.width = `100%`; bar.className = "h-full bg-emerald-500 transition-all";
                        text.innerText = `100%`; text.className = "text-emerald-400";
                        badge.innerText = "DONE";
                        badge.className = "text-[9px] px-1.5 py-0.5 rounded bg-emerald-500/20 text-emerald-400 uppercase font-bold";
                        entry.state = 'done'; checkAllFinished();
                    } else if (data.state === 'FAILURE') {
                        clearInterval(interval);
                        badge.innerText = "FAILED";
                        badge.className = "text-[9px] px-1.5 py-0.5 rounded bg-rose-500/20 text-rose-400 uppercase font-bold";
                        entry.state = 'error'; checkAllFinished();
                    }
                } catch (err) {}
            }, 1500);
        }

        function checkAllFinished() {
            const finishedFiles = selectedFiles.filter(e => e.state === 'done');
            if (selectedFiles.every(e => e.state === 'done' || e.state === 'error')) {
                document.getElementById('finalActions').classList.remove('hidden');
                
                const singleArea = document.getElementById('singleDownloadArea');
                const zipArea = document.getElementById('zipDownloadArea');

                if (finishedFiles.length === 1) {
                    // Single file success -> Direct download
                    singleArea.classList.remove('hidden');
                    zipArea.classList.add('hidden');
                    const btn = document.getElementById('singleDownloadBtn');
                    btn.href = `/download/${finishedFiles[0].output_filename}`;
                    btn.download = finishedFiles[0].output_filename;
                } else if (finishedFiles.length > 1) {
                    // Multiple files -> ZIP
                    singleArea.classList.add('hidden');
                    zipArea.classList.remove('hidden');
                }
            }
        }

        async function downloadAllAsZip() {
            const convertedFiles = selectedFiles.filter(e => e.state === 'done').map(e => e.output_filename);
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('loadingTitle').innerText = "Mengompresi...";
            try {
                const response = await fetch('/create-zip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ batch_id: currentBatchId, filenames: convertedFiles })
                });
                const data = await response.json();
                const zipInterval = setInterval(async () => {
                    const res = await fetch(`/task-status/${data.task_id}`);
                    const status = await res.json();
                    if (status.state === 'SUCCESS') {
                        clearInterval(zipInterval);
                        document.getElementById('loadingOverlay').classList.add('hidden');
                        window.location.href = `/download/${data.zip_filename}`;
                    }
                }, 1000);
            } catch (err) {
                document.getElementById('loadingOverlay').classList.add('hidden');
            }
        }

        function resetUpload() {
            selectedFiles = []; currentBatchId = null;
            document.getElementById('fileInput').value = "";
            document.getElementById('fileList').innerHTML = "";
            document.getElementById('batchActions').classList.add('hidden');
            document.getElementById('finalActions').classList.add('hidden');
            document.getElementById('singleDownloadArea').classList.add('hidden');
            document.getElementById('zipDownloadArea').classList.add('hidden');
        }

        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024; const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function openPreview(url, type) {
            const modal = document.createElement('div');
            modal.className = "fixed inset-0 bg-black/95 z-[100] flex items-center justify-center p-8 animate-in fade-in duration-300";
            modal.onclick = () => modal.remove();
            let content = '';
            if (type.startsWith('image/')) content = `<img src="${url}" class="max-w-full max-h-full rounded-xl">`;
            else if (type.startsWith('video/')) content = `<video src="${url}" controls autoplay class="max-w-full max-h-full rounded-xl"></video>`;
            else if (type.startsWith('audio/')) content = `<audio src="${url}" controls autoplay class="w-full max-w-md"></audio>`;
            else content = `<div class="text-white text-xl">Preview tidak tersedia.</div>`;
            modal.innerHTML = `<div class="relative w-full h-full flex items-center justify-center" onclick="event.stopPropagation()">${content}<button onclick="this.closest('.fixed').remove()" class="absolute top-0 right-0 p-4 text-white hover:text-gray-400 transition-colors"><i data-lucide="x" class="w-8 h-8"></i></button></div>`;
            document.body.appendChild(modal); lucide.createIcons();
        }
    </script>
</body>
</html>
